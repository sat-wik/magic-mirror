const path=require("path"),fs=require("fs"),exec=require("child_process").exec;var _log=Function.prototype.bind.call(console.log,console,"[ASSISTANT:AM]"),log=function(){};class ACTIONMANAGER{constructor(e,t=!1){this.config=e,1==t&&(log=_log)}makeAction(e=(()=>{})){if(log("Making Action:",this.config.autoMakeAction),this.config.autoMakeAction){var t={manifest:{displayName:"MAGICMIRROR CUSTOM DEVICE ACTION",invocationName:"MAGICMIRROR CUSTOM DEVICE ACTION",category:"PRODUCTIVITY"},actions:[],types:[]};this.config.actionLocale&&(t.locale=this.config.actionLocale);var a=this.config.actions;for(var i in a)if(a.hasOwnProperty(i)){var n=i,o=a[i];if(Array.isArray(o.patterns)){var s={name:"",availability:{deviceClasses:[{assistantSdkDevice:{}}]},intent:{name:"",parameters:[],trigger:{queryPatterns:[]}},fulfillment:{staticFulfillment:{templatedResponse:{items:[]}}}};s.name="GA.action."+n,s.intent.name=o.intentName?o.intentName:"GA.intent."+n,s.intent.trigger.queryPatterns=o.patterns,s.intent.parameters=o.parameters?o.parameters:[],s.fulfillment.staticFulfillment.templatedResponse.items[0]={simpleResponse:{textToSpeech:o.response?o.response:""}},s.fulfillment.staticFulfillment.templatedResponse.items[1]={deviceExecution:{command:o.commandName?o.commandName:"GA.command."+n,params:o.commandParams?o.commandParams:{}}},t.actions.push(s),o.types&&(t.types=t.types.concat(o.types))}}var c=JSON.stringify(t,null,2);fs.writeFile(path.resolve(__dirname,"../tmp/action_package.json"),c,"utf8",t=>{t?(log("Error - Action package JSON file creation failed:",t.message),e()):this.gactionCLI(e)})}else e()}gactionCLI(e=(()=>{})){if(log("Updating Action:",this.config.autoUpdateAction),this.config.autoUpdateAction){if(!this.config.projectId)return log("Error - project ID is required. Updating is canceled."),void e();var t=path.resolve(__dirname,"../tmp/action_package.json"),a=`cd ${path.resolve(__dirname,"../utility")}; ./gactions test --action_package ${t} --project ${this.config.projectId}`;e(),exec(a,(t,i,n)=>{log("Executing:",a),t?log("Error - Action Package update failed:",t.message):log("Action Package updated:",[i,n]),e()})}else e()}}module.exports=ACTIONMANAGER;
