const HTMLParser=require("node-html-parser"),path=require("path"),fs=require("fs"),Entities=require("html-entities").AllHtmlEntities,entities=new Entities;var _log=Function.prototype.bind.call(console.log,console,"[ASSISTANT:SP]"),log=function(){};class SCREENPARSER{constructor(e,t){this.config=e,1==t&&(log=_log)}parse(e,t=(()=>{})){if(e.screen){var r=this.config.screenOutputURI,o=path.resolve(__dirname,"..",r),s=e.screen.originalContent.toString("utf8");s=(e=>e.replace(/document\.body,"display","none"/gim,e=>'document.body,"display","block"'))(s);var n="/modules/MMM-GoogleAssistant/"+this.config.screenOutputCSS+"?seed="+Date.now();s=s.replace(/<style>html,body[^<]+<\/style>/gim,`<link rel="stylesheet" href="${n}">`);var i=HTMLParser.parse(e.screen.originalContent),l=i.querySelector(".popout-content");l&&(e.screen.text=l.structuredText),e.screen=this.parseScreenLink(e.screen),e.screen.photos=[];var a=i.querySelectorAll(".photo_tv_image");if(a)for(var u=0;u<a.length;u++)e.screen.photos.push(a[u].attributes["data-image-url"]);fs.writeFile(o,s,s=>{s?(log("CONVERSATION:SCREENOUTPUT_CREATION_ERROR",s),t(s)):(log("CONVERSATION:SCREENOUTPUT_CREATED"),e.screen.path=o,e.screen.uri=r,t(e))})}}parseScreenLink(e){var t=e.originalContent;e.links=[];for(var r=[/data-url=\"([^\"]+)\"/gim,/ (http[s]?\:\/\/[^ \)]+)[ ]?\)/gim,/\: (http[s]?\:\/\/[^ <]+)/gim],o=null,s=[],n=0;n<r.length;n++)for(var i=r[n];null!==(o=i.exec(t));)s.push(entities.decode(o[1]));if(0==s.length){var l=new RegExp("http[s]?://m.youtube.com/watch\\?v=([0-9a-zA-Z-_]+)","ig"),a=new RegExp("http[s]?://m.youtube.com/playlist\\?list=([a-zA-Z0-9-_]+)","ig"),u=l.exec(e.text);a.exec(e.text)?(log("YouTube playlist found:",youtubePlayList[0]),s.push(youtubePlayList[0])):u&&(log("YouTube video found:",u[0]),s.push(u[0]))}return e.links=s,e}}module.exports=SCREENPARSER;
