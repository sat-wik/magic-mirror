const exec=require("child_process").exec,fs=require("fs"),path=require("path"),Assistant=require("./components/assistant.js"),ScreenParser=require("./components/screenParser.js"),ActionManager=require("./components/actionManager.js"),MD5=require("@bugsounet/md5"),Snowboy=require("@bugsounet/snowboy").Snowboy,Player=require("./components/sound.js");var _log=Function.prototype.bind.call(console.log,console,"[ASSISTANT]"),log=function(){},NodeHelper=require("node_helper");module.exports=NodeHelper.create({start:function(){this.config={}},socketNotificationReceived:function(e,t){switch(e){case"INIT":console.log("[ASSISTANT] MMM-GoogleAssistant Version:",require("./package.json").version),new MD5(t,()=>{this.initialize(t)});break;case"ACTIVATE_ASSISTANT":this.activateAssistant(t);break;case"ASSISTANT_BUSY":this.snowboy.stop();break;case"ASSISTANT_READY":this.snowboy.start();break;case"SHELLEXEC":var i=t.command;i+=t.options?" "+t.options:"",exec(i,(e,s,o)=>{log("ShellExec command:",i),e&&console.log("[ASSISTANT] ShellExec Error:"+e),this.sendSocketNotification("SHELLEXEC_RESULT",{executed:t,result:{error:e,stdOut:s,stdErr:o}})});break;case"PLAY_AUDIO":this.player.play(t);break;case"PLAY_CHIME":let s=path.resolve(__dirname,t);this.player.play(s,!1)}},tunnel:function(e){this.sendSocketNotification("TUNNEL",e)},activateAssistant:function(e){log("QUERY:",e);var t=Object.assign({},this.config.assistantConfig);t.debug=this.config.debug,t.lang=e.lang,t.useScreenOutput=e.useScreenOutput,t.useAudioOutput=e.useAudioOutput,t.micConfig=this.config.micConfig,this.assistant=new Assistant(t,e=>{this.tunnel(e)});var i={screenOutputCSS:this.config.responseConfig.screenOutputCSS,screenOutputURI:"tmp/lastScreenOutput.html"},s=new ScreenParser(i,this.config.debug);this.assistant.activate(e,t=>{t.lastQuery=e,t.screen||t.audio||(t.error="NO_RESPONSE",t.transcription&&t.transcription.transcription&&!t.transcription.done&&(t.error="TRANSCRIPTION_FAILS")),"TOO_SHORT"==t.error&&t&&(t.error=null),t.screen?s.parse(t,e=>{delete e.screen.originalContent,log("ASSISTANT_RESULT",e),this.sendSocketNotification("ASSISTANT_RESULT",e)}):(log("ASSISTANT_RESULT",t),this.sendSocketNotification("ASSISTANT_RESULT",t))})},initialize:function(e){this.config=e,this.config.assistantConfig.modulePath=__dirname;var t=null;if(this.config.debug&&(log=_log),fs.existsSync(this.config.assistantConfig.modulePath+"/"+this.config.assistantConfig.credentialPath)?fs.existsSync(this.config.assistantConfig.modulePath+"/"+this.config.assistantConfig.tokenPath)||(t="[ERROR] token.json file not found !"):t="[ERROR] credentials.json file not found !",t)return console.log("[ASSISTANT]"+t),this.sendSocketNotification("NOT_INITIALIZED",t);log("Activate delay is set to "+this.config.responseConfig.activateDelay+" ms"),this.snowboy=new Snowboy(this.config.snowboy,this.config.micConfig,e=>{this.hotwordDetect(e)},this.config.debug),this.snowboy.init(),this.loadRecipes(()=>this.sendSocketNotification("INITIALIZED")),this.config.A2DServer.useA2D&&console.log("[ASSISTANT] Assistant2Display Server Started"),this.config.responseConfig.useNative&&(this.player=new Player(this.config.responseConfig,e=>{this.sendSocketNotification(e)},this.config.debug),console.log("[ASSISTANT] Use native program ("+this.config.responseConfig.playProgram+") for audio response"),this.player.init()),console.log("[ASSISTANT] Google Assistant is initialized.")},loadRecipes:function(e=(()=>{})){if(this.config.recipes){let r=(e,t)=>"function"==typeof t?"__FUNC__"+t.toString():t;for(var t=this.config.recipes,i=[],s=null,o=0;o<t.length;o++)try{var n=require("./recipes/"+t[o]).recipe;this.sendSocketNotification("LOAD_RECIPE",JSON.stringify(n,r,2)),n.actions&&(i=Object.assign({},i,n.actions)),console.log("[ASSISTANT] RECIPE_LOADED:",t[o])}catch(e){return console.log(`[ASSISTANT] RECIPE_ERROR (${t[o]}):`,e.message,e),s=`[ASSISTANT] RECIPE_ERROR (${t[o]})`,this.sendSocketNotification("NOT_INITIALIZED",s)}if(i&&Object.keys(i).length>0){var c=Object.assign({},this.config.customActionConfig);c.actions=Object.assign({},i),c.projectId=this.config.assistantConfig.projectId,new ActionManager(c,this.config.debug).makeAction(e())}else log("NO_ACTION_TO_MANAGE"),e()}else log("NO_RECIPE_TO_LOAD"),e()},hotwordDetect:function(e){e&&this.sendSocketNotification("ASSISTANT_ACTIVATE",{type:"MIC"})}});
